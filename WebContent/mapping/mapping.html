<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>映射管理</title>
  <meta name="keywords" content="我听,我享听">
  <meta name="description" content="我听,我享听">
  <link href="../resources/plugins/hplus/css/bootstrap.min.css" rel="stylesheet">
  <link href="../resources/plugins/hplus/css/font-awesome.min.css" rel="stylesheet">
  <link href="../resources/plugins/hplus/css/animate.min.css" rel="stylesheet">
  <link href="../resources/plugins/hplus/css/style.min.css" rel="stylesheet">
  <link href="../resources/plugins/zTree/css/zTreeStyle/zTreeStyle.css" rel="stylesheet"/>
  <link href="../resources/plugins/hplus/css/plugins/jqpagination/fy.css" rel="stylesheet"/>
  <script src="../resources/plugins/hplus/js/jquery-2.1.1.min.js"></script>
  <script src="../resources/plugins/zTree/js/jquery.ztree.core-3.5.js"></script>
  <script src="../resources/plugins/zTree/js/jquery.ztree.excheck-3.5.js"></script>
  <script src="../resources/plugins/zTree/js/jquery.ztree.exedit-3.5.js"></script>
  <script src="../resources/plugins/hplus/js/bootstrap.min.js"></script>
  <script src="../resources/plugins/hplus/js/content.min.js"></script>
  <script src="../resources/js/context.utils.js"></script>
  <script src="../resources/js/common.utils.js"></script> 
</head>
<style>
/*工具条区域样式*/
.toobarArea{
  height:40px;
  width:20%;
  line-height:30px;
  position:absolute;
  margin-left:40%;
  margin-top:3%;
  overflow:hidden;
}
/*按钮*/
.toobarArea button{
  width:30%;
  height:24px;
  background:#0077c7;
  color:white;
  text-align:center;
  padding:2px;
  font-size:12px;
  border-radius:20px;
}
/*主区域*/
.mainArea{
  height: calc(100% - 10px);
  width: 100%;
  position: absolute;
  overflow:hidden;
}
/*左区域*/
.left{
  height:100%;
  width: 30%;
  float: left;
  margin-left: 10px;
}
.left h4{
  text-align: center;
}
#left_tree,#right_tree{
  height:60%;
  width: 100%;
  padding:1px 1px 1px 1px;
  border: 2px solid #0077c7;
  border-radius: 4px;
  overflow:auto;
}
.relation{
  text-align: center;
}
.otherContent,.wtContent{
  height:29%;
  width: 100%;
  padding:1px 1px 1px 1px;
  border: 2px solid #0077c7;
  border-radius: 4px;
  overflow:auto;
}
/*中间区域*/
.center{
  height: 71%;
  width: 36%;
  border: 2px solid #0077c7;
  border-radius: 4px;
  float: left;
  margin-top: 84px;
  margin-left: 10px;
}
.center h4{
  text-align:center;
  margin-left: -17px;;
}
.correspondContent{
  height: 84%;
  width: 100%;
  border-top: 1px solid black;
  float: left;
  margin-top: 6px;
  margin-left: 0px;
  overflow:auto;
}
/*右侧区域*/
.right{
  height:100%;
  width: 30%;
  float: left;
  margin-left:10px;
}
.right_header{
  height:30px;
  width:100%;
  overflow: hidden;
}
.right_header h4{
  width:100%;
  text-align:center;
  float:left;
}
.right_header select{
  float: left;
  margin-left: 15%;
  margin-top: 3px;
}
#right_tree .newli{
  height:20px;
  margin-top: 0px;
  text-align: center;
  line-height: 20px;
  font-size: 12px;
  border-bottom: 1px solid black;
  cursor:pointer;
}
.newDiv{
  width: 100%;
  height:40px;
  border-bottom: 1px solid black;
}
.check{
  position: relative;
  top: 2px;
  left: 2px;
}
.newDiv span:nth-child(4){
  margin-left: 5px;
  margin-right: 0px;
  color: red;
}
</style>
<body style="overflow:hidden;">
  <div style='height:100%;'>
  	<!--主区域-->
    <div class="mainArea">
      <!--菜单栏-->
      <div class="toobarArea">
        <button type="button" id="add" opeType="claAdd" class="btn" style="margin-right:3px;">添加</button>
        <button type="button" id="del" opeType="claDel" class="btn" style="margin-right:3px;">删除</button>
        <button type="button" id="save" opeType="claSave" class="btn" style="margin-right:3px;">保存</button>
      </div>
    	<!--左侧区域-->
    	<div class="left">
    	  <h4>我听的分类</h4>
    	  <ul id="left_tree" class="ztree"></ul>
    	  <h5 class="relation">对应其他平台的分类</h5>
    	  <div class="otherContent"></div>
    	</div>
    	<!--中间区域-->
      <div class="center">
        <h4>栏目映射编辑日志</h4>
        <div class="correspondContent"></div>
      </div>
      <!--右侧区域-->
      <div class="right">
        <div class="right_header">
        	<h4>其他平台的的分类</h4>
        </div>
        <ul id="right_tree" class="ztree"></ul>
        <h5 class="relation">对应其他平台的分类</h5>
        <div class="wtContent"></div>
      </div>
    </div>
  </div>
</body>
<script>
var wtObj,otherObj,nodes,treeNode,newli,lnodes,rnodes,lTreeNode,rTreeNode;
var rootPath=getRootPath();
/*初始化方法：页面加载完成后执行*/
$(function(){
  //0-初始化页面
  //0.1-配置左边树相关参数
  var settingLT={
    view:{
      selectedMulti:false//是否允许同时选中多个节点
    },
    data:{
      simpleData:{
        enable: true
      }
    },
    callback:{
      onClick:selectLeftTreeNode
    }
  };
  //0.2-配置右边树相关参数
  var settingRT={
    view:{
      selectedMulti:false//是否允许同时选中多个节点
    },
    data:{
      simpleData:{
        enable: true
      }
    },
    callback:{
      onClick:selectRightTreeNode
    }
  };
  
  //0.3-加载左右两边的树
  wtObj=$.fn.zTree.init($("#left_tree"), settingLT);
  otherObj=$.fn.zTree.init($("#right_tree"), settingRT);
  
  //0.41-添加映射关系
  $("#add").on("click",function(){
    addMapping();
  });
  
  //0.42-删除映射关系
  $("#del").on("click",function(){
    beforeRemove();
  });
  
  //0.43-保存映射关系
  $("#save").on("click",function(){
    saveMapping();
  })
  
});

/**
 * 初始化完成后执行相关操作的方法
*/

//1加载我听的树
loadWtTree();
function loadWtTree(){
  var _url=rootPath+"baseinfo/getChannelTree4View.do";
  var loadWtData=[{ChannelId:"",TreeViewType:"zTree"}];
  $.ajax({
    type: "POST",    
    url: _url,
    dataType: "json",
    data: loadWtData,
    success: function(jsonData){
      if(jsonData.ReturnType=="1001") {
        wtObj.addNodes(null,jsonData.Data.children,false);
      }
    },
    error:function(jqXHR){
      alert("发生错误" + jqXHR.status);
    }
  });
}

//2加载其他平台的树
loadCorrespondTree();
function loadCorrespondTree(){
  var _url=rootPath+"/baseinfo/getCCatalogTree4View.do";
  $.ajax({
    type: "POST",    
    url: _url,
    dataType: "json",
    success: function(jsonData){
      if(jsonData.ReturnType=="1001") {
        otherObj.addNodes(null,jsonData.Data.children,false);
      }
    },
    error:function(jqXHR){
      alert("发生错误" + jqXHR.status);
    }
  });
}

//3选中我听的分类，查询我听与当前选中平台的分类映射关系
function selectLeftTreeNode(event, treeId, treeNode){
  var _url=rootPath+"common/getCCateRefs.do";
  var _data={"DictMId":"3","DictDId":treeNode.id,"SourceNum":"0"};
  $.ajax({
    type: "POST",    
    url: _url,
    dataType: "json",
    data:_data,
    success: function(jsonData){
      $(".otherContent").html("");//清空数据
      if(jsonData.ReturnType=="1001") {
        //加载和对应平台的栏目
        for(var i=0;i<jsonData.ResultList.length;i++) {          
          var newDiv=$("<div class='newDiv'></div>");
          var newRadio=$("<input value="+jsonData.ResultList[i].Id+" type='radio' class='check' name='radio' value='0'>");
          var newSpan1=$("<span>【我听】</span>");
          var newSpan2=$("<span>"+"["+treeNode.name+"]"+"</span>");
          var newSpan3=$("<span>对应</span>");
          var newSpan4=$("<span>"+"【"+jsonData.ResultList[i].Publisher+"】"+"</span>");
          var newSpan5=$("<span>"+"["+jsonData.ResultList[i].SrcTitle+"]"+"</span>");
          var newSpan6=$("<br /><span style='margin-left:19px;'>"+jsonData.ResultList[i].CTime+"</span>");
          newDiv.append(newRadio).append(newSpan1).append(newSpan2).append(newSpan3).append(newSpan4).append(newSpan5).append(newSpan6);     
          $(".otherContent").append(newDiv);
        }
      }else{
        alert("无关联数据!");
      }
    },
    error:function(jqXHR){
      alert("发生错误" + jqXHR.status);
    }
  });
}

//4选中其他平台的分类，查询当前选中平台与我听的分类映射关系
function selectRightTreeNode(event, treeId, treeNode){
  var _url=rootPath+"common/getCCateRefs.do";
  var _data={"DictMId":"3","DictDId":treeNode.id,"SourceNum":"1"};
  $.ajax({
    type: "POST",    
    url: _url,
    dataType: "json",
    data:_data,
    success: function(jsonData){
      $(".wtContent").html("");//清空数据
      if(jsonData.ReturnType=="1001") {
        var pNode=treeNode.getParentNode();//当前选中节点的父节点
        for(var i=0;i<jsonData.ResultList.length;i++) {
          var newRadio=$("<input value="+jsonData.ResultList[i].Id+" type='radio' class='check' name='radio' value='0'>");
          var newDiv=$("<div class='newDiv'></div>");
          var newSpan1=$("<span>"+"【"+treeNode.name+"】"+"</span>");
          var newSpan2=$("<span>"+"["+pNode.name+"]"+"</span>");
          var newSpan3=$("<span>对应</span>");
          var newSpan4=$("<span>"+"【"+jsonData.ResultList[i].Publisher+"】"+"</span>");
          var newSpan5=$("<span>"+"["+jsonData.ResultList[i].SrcTitle+"]"+"</span>");
          var newSpan6=$("<br /><span style='margin-left:19px;'>"+jsonData.ResultList[i].CTime+"</span>");
          newDiv.append(newRadio).append(newSpan1).append(newSpan2).append(newSpan3).append(newSpan4).append(newSpan5).append(newSpan6);     
          $(".wtContent").append(newDiv);
        }
      }else{
        alert("无关联数据!");
      }
    },
    error:function(jqXHR){
      alert("发生错误" + jqXHR.status);
    }
  });
}

//5添加映射关系
function addMapping(){
  lnodes=wtObj.getSelectedNodes();//获取 left_tree当前被选中的节点数据集合
  ltreeNode=lnodes[0]; //当前选中的节点
  rnodes=otherObj.getSelectedNodes();//获取 right_tree当前被选中的节点数据集合
  rTreeNode=rnodes[0]; //当前选中的节点
  var _url=rootPath+"common/addCCateRef.do";
  var _data={"DictMId":"3","DictDId":ltreeNode.id,"CDictMId":"3","CDictDId":rTreeNode.id};
  $.ajax({
    type: "POST",    
    url: _url,
    dataType: "json",
    data:_data,
    success: function(jsonData){
      if(jsonData.ReturnType=="1001") {
        //加载和其他平台对应的栏目
        //$(".correspondContent").html("");//暂时先不清数据
        var newDiv=$("<div class='newDiv'></div>");
        var newRadio=$("<input value="+jsonData.Id+" type='radio' class='check' name='radio'>");
        var newSpan1=$("<span>【我听】</span>");
        var newSpan2=$("<span>"+"["+ltreeNode.name+"]"+"</span>");
        var newSpan3=$("<span>对应</span>");
        var newSpan4=$("<span>"+"【"+rTreeNode.getParentNode().name+"】"+"</span>");
        var newSpan5=$("<span>"+"["+rTreeNode.name+"]"+"</span>");
        var newSpan6=$("<span style='margin-left:6px;'>"+jsonData.CTime+"</span>");
        newDiv.append(newRadio).append(newSpan1).append(newSpan2).append(newSpan3).append(newSpan4).append(newSpan5).append(newSpan6);
        $(".correspondContent").append(newDiv);
      }else{
        alert("映射关系已存在!");
      }
    },
    error:function(jqXHR){
      alert("发生错误" + jqXHR.status);
    }
  });
}

//6.1确认是否删除映射关系
function beforeRemove(){
  if(confirm("确认删除 节点 -- " + ltreeNode.name +"和"+ rTreeNode.name +" 的对应关系吗？")){
    delMapping();
  }else{
    alert("成功取消删除");
  }
}

//6.2删除映射关系
function delMapping(){
  var checked=$("input[name='radio']:checked");
  var _url=rootPath+"common/removeCCateRefs.do";
  var _data={"Id":checked.attr("value")};
  $.ajax({
    type: "POST",    
    url: _url,
    dataType: "json",
    data:_data,
    success: function(jsonData){
      if(jsonData.ReturnType=="1001") {
        $("input[name='radio']:checked").parent().remove();
        alert("删除成功!");
      }else{
        alert("删除失败!");
      }
    },
    error:function(jqXHR){
      alert("发生错误" + jqXHR.status);
    }
  });
}

//7保存映射关系
function saveMapping(){
  var _url=rootPath+"common/saveCCateRefs.do";
  $.ajax({
    type: "POST",    
    url: _url,
    dataType: "json",
    success: function(jsonData){
      if(jsonData.ReturnType=="1001") {
        alert("保存成功！");
      }else{
        alert("保存失败！");
      }
    },
    error:function(jqXHR){
      alert("发生错误" + jqXHR.status);
    }
  });
}

</script>
</html>
