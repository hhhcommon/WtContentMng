<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>忘记密码</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="keywords" content="我听，我享听">
  <meta name="description" content="我听，我享听">
  <link href="../resources/plugins/hplus/css/bootstrap.min.css" rel="stylesheet">
  <link href="../resources/plugins/hplus/css/font-awesome.min.css" rel="stylesheet">
  <link href="../resources/plugins/hplus/css/animate.min.css" rel="stylesheet">
  <link href="../resources/plugins/hplus/css/style.min.css" rel="stylesheet">
  <script src="../resources/plugins/hplus/js/jquery-2.1.1.min.js"></script>
  <script src="../resources/js/mainPage.js"></script>
  <script src="../resources/js/context.utils.js"></script>
</head>
<style>
*{margin: 0;padding: 0;}
li{list-style: none;}
a,a:hover,a:link,a:focus,a:visited{text-decoration: none;}
::-webkit-scrollbar {height:12px;width:2px;background:#e7eaec; } 
::-webkit-scrollbar-thumb{height:12px;width:2px;background:#e7eaec;}
html,body{height:100%;overflow-x: auto;font-family: "微软雅黑";}
.wrapper{
  width:100%;
  height:100%;
  position: absolute;
  background-image:url("img/bg.jpg");
  background-size:100% 100%;
}
.header{
  width:100%;
  height:80px;
  background: #ffa634;
}
.header img{
  background-size:100% 100%;
}
.containers{
  width:450px;
  margin:80px auto;
  background: #fff;
}
.nav_tabs{
  padding: 20px 0px;
  text-align: center;
  font-size: 24px;
  color:#FFA634;
}
.con_tabs{
  width: 100%;
  padding:0px 40px 20px;
}
.div1,.div2,.div3,.div4{
  width:100%;
  height:40px;
  margin-top:15px;
}
.div4{
  margin-top:40px;
}
.div1 span,.div2 span,.div3 span{
  width:50px;
  height:100%;
  color: #000;
  font-size:16px;
}
.div1 input,.div2 input{
  width:310px;
  height:100%;
  padding:2px 7px;
}
.div3 .ver_code{
  width:150px;
  height:40px;
  line-height:40px;
  background: #ffa634;
  color: #fff;
  display: inline-block;
  margin-left:10px;
  text-align: center;
  border: none;
  cursor: pointer;
}
.div3 input{
  width:150px;
  height: 40px;
  padding: 2px 7px;
}
.save_btn{
  width: 100%;
  height: 40px;
  line-height: 40px;
  display: block;
  text-align: center;
  background:#ffa634;
  color:#fff;
  font-weight: bold;
  font-size: 16px;
  border: none;
  border-radius: 4px;
}
form{
  margin-bottom: 25px;
}
.mask_gif{
  width: 450px;
  height: 395px;
  position: absolute;
  background: rgba(0,0,0,0.6);
  display: none;
}
.mask_gif img{
  width: 50px;
  height: 50px;
  position: absolute;
  margin-top: 130px;
  margin-left: 190px;
}
</style>
<body onselectstart="return false">
  <div class="wrapper">
    <div class="header">
      <img src="img/logo1.png" alt="logo" />
    </div>
    <div class="containers">
      <div class="mask_gif">
        <img src="img/waiting_circle.gif" alt="图片上传等待" />
      </div>
      <div class="nav_tabs">
        <span>重置密码</span>
      </div>
      <div class="con_tabs">
        <div class="fgpw_area con_tab">
          <form id="fgpw_form">
            <div class="div1">
              <span>账&nbsp;&nbsp;&nbsp;号</span>
              <input type="text" placeholder="手机号/用户名" />
            </div>
            <div class="div2">
              <span>新密码</span>
              <input type="password" placeholder="请输入新密码" />
            </div>
            <div class="div3">
              <span>验证码</span>
              <input class="codeval" type="text" placeholder="验证码" />
              <input type="button" class="ver_code" value="获取验证码"/>
            </div>
            <div class="div4">
              <input type="submit" value="确   定" class="save_btn"/>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>   
</body>
<script>
$(function(){
  var rootPath=getRootPath();
  var deviceId="";
  var pcdType=3;
    
  //点击发送验证码 
  var InterValObj; //timer变量，控制时间  
  var curCount=60;//当前剩余秒数  
  var clicknum=0;
  $(".ver_code").on("click",function(){
    clicknum++;
    var sMobile=$.trim($("#fgpw_form .div1 input").val());
    if(!sMobile){
      alert("账号不能为空");
      $("#fgpw_form .div1 input").val("").focus(); 
      return false; 
    }else{
      var myreg=/^1[3|4|5|7|8][0-9]{9}$/;
      if(!(myreg.test(sMobile))){ 
        alert("手机号输入不合法，请重新输入"); 
        $("#fgpw_form .div1 input").val("").focus(); 
        return false; 
      }else{
        if(clicknum>1){//点击起到的是重发效果
          var _url=rootPath+"passport/user/reSendPhoneCheckCode.do";
          getCode(_url,sMobile);//不是第一次得到验证码
        }else{//第一次发送验证码
          var _url=rootPath+"passport/user/retrieveByPhoneNum.do";
          getCode(_url,sMobile);//第一次得到验证码
        }
      }
    }
  });
  
  //获取验证码
  function getCode(_url,sMobile){
    var _data={};
    _data.IMEI=deviceId;
    _data.PCDType=pcdType;
    _data.PhoneNum=sMobile;
    _data.OperType=1;
    $.ajax({
      type:"POST",
      url:_url,
      dataType:"json",
      data:JSON.stringify(_data),
      success:function(returnData){
        if(returnData.ReturnType=="1001"){
          InterValObj=window.setInterval(SetRemainTime, 1000); //启动计时器，1秒执行一次
        }else{
          alert("此手机号已注册，请换其他手机号注册");
        }
      },
      error:function(jqXHR){
        alert("发生错误" + jqXHR.status);
      }
    });
  }
  //计时器timer的时间处理
  function SetRemainTime(){  
    if(curCount==0){                  
      window.clearInterval(InterValObj);//停止计时器  
      $(".ver_code").removeAttr("disabled").val("重新发送验证码").css("background","#ffa634");//启用按钮  
      $(".codeval").val(" "); //清除验证码。如果不清除，过时间后，输入收到的验证码依然有效      
    }else{  
      curCount--;  
      $(".ver_code").val("请在" + curCount + "秒内输入验证码").attr("disabled", "true").css("background","#333");
    }  
  }
  
  //重置密码--点击确定
  $(".save_btn").on("click",function(){
    var sMobile=$.trim($("#fgpw_form .div1 input").val());
    var sPassword=$.trim($("#fgpw_form .div2 input").val());
    var sCode=$.trim($("#fgpw_form .codeval").val());
    if(!sMobile){
      alert("账号不能为空");
      $("#fgpw_form .div1 input").val("").focus(); 
      return false; 
    }else{
      var myreg=/^1[3|4|5|7|8][0-9]{9}$/;
      if(!(myreg.test(sMobile))){ 
        alert("手机号输入不合法，请重新输入"); 
        $("#fgpw_form .div1 input").val("").focus(); 
        return false; 
      } 
    }
    if(!sCode){
      alert("验证码不能为空");
      $("#fgpw_form .codeval").val("").focus(); 
      return false; 
    }else{
      if(sCode.length!=6){ 
        alert("验证码只能是6位，请重新输入"); 
        $("#fgpw_form .codeval").val("").focus(); 
        return false; 
      }else{
        checkCode(sMobile,sCode,sPassword);//验证输入的验证码是否正确
      }
    }
    if(!sPassword){
      alert("新密码不能为空");
      $("#fgpw_form .div2 input").val("").focus(); 
      return false; 
    }else{
      var myreg = /(^[a-z]+$|^[A-Z]+$|^\d+$|^_+$)/;
      if((!(myreg.test(sPassword)))||sPassword.length<6||sPassword.length>20){ 
        alert("密码输入不合法，请重新输入"); 
        $("#fgpw_form .div2 input").val("").focus(); 
        return false; 
      }
    }
  });
  
  //验证验证码，用于找回用户
  function checkCode(sMobile,sCode,sPassword){
    var data={};
    data.IMEI=deviceId;
    data.PCDType=pcdType;
    data.PhoneNum=sMobile;
    data.CheckCode=sCode;
    data.NeedUserId=true;
    $.ajax({
      type:"POST",
      url:rootPath+"passport/user/checkPhoneCheckCode.do",
      dataType:"json",
      data:JSON.stringify(data),
      success:function(returnData){
        if(returnData.ReturnType=="1001"){
          var userId=returnData.UserId;
          checkCodeOk(userId,sPassword,sMobile);//验证码验证成功后，得到用户的id后重置密码
        }else{
          alert(returnData.Message);
        }
      },
      error:function(jqXHR){
        alert("发生错误" + jqXHR.status);
      }
    });
  }
  
  //验证码验证成功后，得到用户的id后重置密码
  function checkCodeOk(userId,sPassword,sMobile){
    var data={};
    data.IMEI=deviceId;
    data.PCDType=pcdType;
    data.RetrieveUserId=userId;
    data.NewPassword=sPassword;
    $.ajax({
      type:"POST",
      url:rootPath+"passport/user/updatePwd_AfterCheckPhoneOK.do",
      dataType:"json",
      data:JSON.stringify(data),
      success:function(returnData){
        if(returnData.ReturnType=="1001"){
          alert("恭喜你，密码重置成功");
          window.location.href="./login.html";
        }else{
          alert(returnData.Message);
        }
      },
      error:function(jqXHR){
        alert("发生错误" + jqXHR.status);
      }
    });
  }
});
</script>
</html>
