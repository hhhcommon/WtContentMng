<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>全局播放器</title>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="keywords" content="我听，我享听">                                                              
  <meta name="description" content="我听，我享听">
  <link href="../resources/plugins/hplus/css/bootstrap.min.css" rel="stylesheet">                                                                     
  <link href="../resources/plugins/hplus/css/font-awesome.min.css" rel="stylesheet">
  <link href="../resources/plugins/hplus/css/animate.min.css" rel="stylesheet">
  <link href="../resources/plugins/hplus/css/style.min.css" rel="stylesheet">
  <link href="css/globalplayer.css" rel="stylesheet">
  <script src="../resources/plugins/hplus/js/jquery-2.1.1.min.js"></script>
  <script src="../resources/js/common.utils.js"></script>
  <script src="../resources/js/context.utils.js"></script>
  <script src="../resources/plugins/hplus/js/plugins/datapicker/bootstrap-datepicker.js"></script><!--日期-->
</head>
<body>
<!--s:全局播放器-->
<div class="globalplayer">
  <audio src="" class="audio" id='audio' controls style="display: none;"></audio>
  <!--s:展开状态-->
  <div class="glp_block">
    <div class="glp_panel">
      <div class="controls">
        <img class="btn_prev prevBtn" src="img/prev.png" alt="前一首" />
        <img class="btn_player playerBtn" src="img/play.png" alt="播放/暂停" />
        <img class="btn_next nextBtn" src="img/next.png" alt="后一首" />
      </div>
      <div class="player_panel">
        <a href="#" class="title" title=""></a>
        <div>
          <span class="time sound_position">00:00</span>
          <div class="player_progressbar">
            <div class="player_playbar"></div>
            <div class="player_circle"></div>  
          </div>
          <span class="time sound_duration"></span>
        </div>
      </div>
      <div class="volume_panel">
        <img src="img/volume.png" alt="音量图标" class="volume_img no_mute"/>
        <div class="volume_progressbar">
          <div class="volume_playbar"></div>
          <div class="volume_circle"></div> 
        </div>
      </div>
    </div>
  </div>
  <!--e:展开状态-->
</div>
<!--e:全局播放器-->
</body>
<script>
$(function(){
  var audioList=window.parent.audioList;
  var listNum=0;//控制播放节目的序号
  console.log(audioList);
  
  if(audioList.length!=0){//有音频
    /*点击打开或关闭锁*/
    $(".locker",parent.document).on("click",function(){
      $(".audio").attr("src",audioList[0].playUrl);
      $(".title").text(audioList[0].title);
    });
    
    /*点击播放器面板上的播放按钮*/
    $(".playerBtn").on("click",function(){
      if($(this).hasClass("playing")){//正在播放
        $(this).removeClass("playing").attr("src","img/play.png");
        $(".audio")[0].pause();
      }else{//正在暂停
        $(this).addClass("playing").attr("src","img/pause.png");
        $(".audio")[0].play();
      }
    });
    
    /*实时获取播放时长和改变进度条进度*/
    $(".audio")[0].addEventListener("timeupdate",function(){
      if(!isNaN(this.duration)){
        //播放进度条
        var progressValue = this.currentTime/this.duration*($(".player_progressbar").width());
        $('.player_circle')[0].style.left = parseInt(progressValue) + 'px';
        $(".player_playbar").css("width",progressValue+"px");
        //播放时长
        if(formatTime(Math.floor(this.currentTime))!=0){
          $(".sound_position").text(formatTime(Math.floor(this.currentTime)));
        }
      };
    },false);
    
    /*监控audio是否播放完毕,播放完毕后自动播放下一首*/
    $(".audio")[0].addEventListener("ended",function(){ 
      $(".nextBtn").click();
    },false);
    
    /*获取节目时长*/
    getAudioTime();
    function getAudioTime(){
      setTimeout(function(){
        var duration = $(".audio")[0].duration;
        if(isNaN(duration)){//检查参数是否是非数字
          getAudioTime();
        }else{
          var longtime=$(".audio")[0].duration;
          console.log(longtime);
          $(".sound_duration").text(formatTime(longtime));
        }
      }, 10);
    }
  }
  
  /*实现播放快进和后退*/
  $(".player_progressbar").on("click",function(event){
    var e = event || window.event;
    var scrollX = document.documentElement.scrollLeft || document.body.scrollLeft;
    var x = e.pageX || e.clientX + scrollX;
    var pleft=x-335;
    var clickPlayTime=pleft*($(".audio")[0].duration)/$(".player_progressbar").width();
    $('.player_circle')[0].style.left = parseInt(pleft) + 'px';
    $(".player_playbar").css("width",pleft+"px");
    $('.audio')[0].currentTime=clickPlayTime;
    $(".sound_position").text(formatTime(Math.floor(clickPlayTime)));
  });
  
  /*实现静音*/
  var clickVolume="1";//音量大小
  $(".volume_img").on("click",function(event){
    if($(this).hasClass("no_mute")){
      $(this).removeClass("no_mute").attr("src","img/mute.png");
      $('.audio')[0].volume="0";
    }else{
      $(this).addClass("no_mute").attr("src","img/volume.png");
      $('.audio')[0].volume=clickVolume;
    }
  });
  
  /*实现音量的增大和减小*/
  $(".volume_progressbar").on("click",function(event){
    var e = event || window.event;
    var scrollX = document.documentElement.scrollLeft || document.body.scrollLeft;
    var x = e.pageX || e.clientX + scrollX;
    var pleft=x-770;
    clickVolume=pleft/$(".volume_progressbar").width();
    $('.volume_circle')[0].style.left = parseInt(pleft) + 'px';
    $(".volume_playbar").css("width",pleft+"px");
    $('.audio')[0].volume=clickVolume;
  });
  
  /*点击播放器面板上的上一首按钮*/
  $(document).on("click",".prevBtn",function(){
    if(listNum<=0){
      return false;
    }else{
      listNum--;
      for(var i=0;i<audioList.length;i++){
        if(listNum==i){
          $(".audio").attr({"src":audioList[listNum].playUrl});
          $(".player_panel .title").html(audioList[listNum].title);
          $(".sound_position").html("00:00");
          getAudioTime();
          reset();
          return;
        }
      }
    }
  });
  
/*点击播放器面板上的下一首按钮*/
  $(document).on("click",".nextBtn",function(){
    if(listNum>=audioList.length-1){
      return false;
    }else{
      listNum++;
      for(var i=0;i<audioList.length;i++){
        if(listNum==i){
          $(".audio").attr({"src":audioList[listNum].playUrl});
          $(".player_panel .title").html(audioList[listNum].title);
          $(".sound_position").html("00:00");
          getAudioTime();
          reset();
          return;
        }
      }
    }
  });
  
  /*秒转时分秒格式--播放时刻*/
  function formatTime(longTime){
    var time=parseFloat(longTime);
    if(time!=null && time !=""){
      if(time<60){
        var s=parseInt(time);
        if(s<10){
          time="00:0"+s;
        }else{
          time="00:"+s;
        }
      }else if(time>60 && time<3600){
        var m=parseInt(time / 60);
        var s=parseInt(time %60);
        m = m >= 10 ? m : "0" + m;
        s = s >= 10 ? s : "0" + s;
        time=m+":"+s;
      }else if(time>=3600 && time<86400){
        var h=parseInt(time / 3600);
        var m=parseInt(time % 3600 /60);
        var s=parseInt(time %3600 %60 %60);
        m = m >= 10 ? m : "0" + m;
        s = s >= 10 ? s : "0" + s;
        time=h+":"+m+":"+s;
      }
    }
    return time;
  }
  
  /*播放过程中切换节目进行复位*/
  function reset(){
    $(".playerBtn").removeClass("playing").attr("src","img/play.png");
    $('.player_circle')[0].style.left ='0px';
    $(".player_playbar").css("width","0px");
    $(".playerBtn").click();
  }

});
</script>
</html>
