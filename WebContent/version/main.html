<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta name="keywords" content="Apk, 版本管理">
  <meta name="description" content="实现我听Android平台的Apk文档发布和简单的版本说明功能">

  <title>Apk版本管理</title>
  <link href="../resources/plugins/hplus/css/bootstrap.min.css" rel="stylesheet">
  <link href="../resources/plugins/hplus/css/font-awesome.min.css" rel="stylesheet">

  <link href="../resources/plugins/hplus/css/animate.min.css" rel="stylesheet">
  <link href="../resources/plugins/hplus/css/plugins/datapicker/datepicker3.css" rel="stylesheet">

  <link href="../resources/plugins/summernote/summernote.css" rel="stylesheet">

  <link href="../resources/wtcm/css/CM_mainarea.css" rel="stylesheet">
  <link href="../resources/wtcm/css/CM_toolbar.css" rel="stylesheet">
  <link href="../resources/wtcm/css/CM_pagination.css" rel="stylesheet">
  <link href="../resources/wtcm/css/CM_listoneline.css" rel="stylesheet">

  <script src="../resources/js/common.utils.js"></script>
  <script src="../resources/plugins/hplus/js/jquery-2.1.1.min.js"></script>

  <script src="../resources/plugins/hplus/js/bootstrap.min.js"></script>
  <script src="../resources/plugins/hplus/js/plugins/jqpagination/jquery.jqpagination.js"></script><!-- 分页 -->
  <script src="../resources/plugins/hplus/js/plugins/datapicker/bootstrap-datepicker.js"></script><!--日期-->
  <script src="../resources/js/context.utils.js"></script>

  <script src="../resources/plugins/summernote/summernote.min.js"></script>
  <script src="../resources/plugins/summernote/lang/summernote-zh-CN.js"></script>

  <script src="../resources/js/common.utils.js"></script>
  <script src="../resources/wtcm/js/CM_pagination.js"></script>
</head>
<style>
<!--
/*模态窗口样式设置*/
.my-mbody {
  background-color: #F8FAFB;
}
.my-mdialog {
  margin:80px auto;
}
h4 {
  font-weight:bold;
  padding-left:10px;
  text-align:left;
}

/* 配置：表单区域 */
.modal-body tr {
  width:100%;
}
.modal-body tr .th {
  margin-left:30px;
  height:60px;
  line-height:36px;
  font-size:14px;
  font-weight:bold;
  font-family:"open sans","Helvetica Neue",Helvetica,Arial,sans-serif;
  width:200px;
  text-width:190px;
  padding-right:10px;
  font-weight:nomal;
  text-align:right;
}
.modal-body tr .add-th {
  width:120px;
}
.modal-body tr td input {
  width:380px;
}
.splittr {
  border-top:1px dashed #e5e5e5;
  height:10px;
}
.my-mbody input {
}

/*操作按钮*/
.my-btnOper {
  margin-top:10px;
  margin-left:450px;
}
.my-btnOper button {
  height:28px;
  line-height:28px;
  padding:0px 12px;
}
-->
</style>
<body style="overflow:hidden;"><div style="height:100%">
<!--菜单栏-->
<div class="toobarArea">
  <button type="button" opeType="verAdd" class="btn" style="margin-right:10px" data-toggle="modal" data-target="#verAdd">添加</button>
  <button type="button" opeType="verDel" class="btn" style="margin-right:175px" disabled>删除</button>
  <div class="splite" style="left:300px"></div>
  <button type="button" opeType="verconfig" class="btn" style="margin-right:60px" data-toggle="modal" data-target="#verCfg">配置信息</button>
  <div class="splite" style="left:418px"></div>
  <div class="form-group cDate" id="data_5">
    <span>发布日期：</span>
    <div class="input-daterange input-group" id="datepicker" style="display:inline-block;vertical-align:top;margin-top:2px;">
      <input type="text" class="input-sm form-control" name="StartPubTime" value="" />
      <input type="text" class="input-sm form-control" name="EndPubTime" value="" />
    </div>
  </div>
  <button type="button" class="btn selectBtn" disabled>查 询</button>
</div>

<!--显示主区域-->
<div class="mainArea">
  <!--左侧列表 -->
  <div id="verListArea" class="leftlistArea">
    <!-- 动态节目列表cntList -->
    <div class="cntList"></div>
    <div class="page">
      <div class="gigantic pagination">
        <span class="first" data-action="first">&laquo;首页</span>
        <span class="previous" data-action="previous">&lsaquo;上页</span>
        <span class="next" data-action="next">下页&rsaquo;</span>
        <span class="last" data-action="last">尾页&raquo;</span>
        <span class="jump" data-action="toPage">跳至</span><span><input type="text" class="toPage" value=""/></span>
        <i>共</i><i class="totalPage"></i><i>页</i>
      </div>
    </div>
  </div>
  <!--右侧详情-->
  <div class="detailArea">ettsetstet 收拾收拾
  </div>
</div>

<!--弹出内容：设置配置-->
<div id="verCfg" class="modal inmodal" data-backdrop="static">
  <div class="modal-dialog my-mdialog">
    <div class="modal-content">
      <div class="modal-header" style="padding-bottom:5px;">
        <button type="button" class="close" id="closeB_verCfg" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title">版本配置信息</h4>
        <div class="btn-group my-btnOper">
          <button id="browserB" class="btn btn-primary" type="button">浏览</button>
          <button id="updateB" class="btn btn-white" type="button">修改</button>
        </div>
      </div>
      <div class="modal-body my-mbody">
        <table>
          <tr>
            <td class="th">当前发布版本Apk名称</td>
            <td><input type="text" class="form-control" id="pubFileName" placeholder="当前发布版本的名称" readonly></td>
          </tr>
          <tr>
            <td class="th">当前发布版本下载地址</td>
            <td><input type="text" class="form-control" id="pubUrl" placeholder="当前发布版本的Url，下载地址就从此获得" readonly></td>
          </tr>
          <tr>
            <td class="th">当前发布版本存储目录</td>
            <td><input type="text" class="form-control" id="pubStorePath" placeholder="服务器端目录设置，默认为/opt/version/cur" readonly></td>
          </tr>
          <tr class="splittr"></tr>
          <tr>
            <td class="th">历史版本发布存储目录</td>
            <td><input type="text" class="form-control" id="verGoodsStorePath" placeholder="服务器端目录设置，默认为/opt/version/his/+{版本序号}" readonly></td>
          </tr>
        </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-white" data-dismiss="modal">关闭</button>
        <button id="saveCfgB" type="button" class="btn btn-primary">保存</button>
      </div>
    </div>
  </div>
</div>

<!--弹出内容：新增版本-->
<div id="verAdd" class="modal inmodal" data-backdrop="static">
  <div class="modal-dialog my-mdialog" style="width:1000px;">
    <div class="modal-content">
      <div class="modal-header" style="padding-bottom:5px;">
        <button type="button" class="close" id="closeB_ver" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title" style="margin-bottom:5px;">添加版本</h4>
      </div>
      <div class="modal-body my-mbody">
        <table>
          <tr>
            <td class="th add-th">版本名称</td>
            <td colspan="3"><input type="text" class="form-control" id="verName" placeholder="版本名称" style="width:440px;"></td>
            <td rowspan="3" style="width:400px;padding:10px;"><div style="width:100px;height:100px; border:1px solid black;"></div></td>
          </tr>
          <tr>
            <td class="th add-th">版本号</td>
            <td><input type="text" class="form-control" id="verNum" placeholder="版本号" style="width:170px;"></td>
            <td class="th add-th" style="width:100px;">版本状态</td>
            <td><select class="form-control" id="verFlag" placeholder="状态" style="width:170px;">
              <option value=1>发布</option>
              <option value=0>草稿</option>
            </select></td>
          </tr>
          <tr>
            <td class="th add-th">上传版本文件</td>
            <td colspan="3"><input type="text" class="form-control" id="pubUrl" placeholder="当前发布版本的Url，下载地址就从此获得" style="width:440px;"></td>
          </tr>
          <tr>
            <td class="th add-th">版本说明</td>
            <td colspan="4"><textarea id="verMemo" placeholder="版本说明" autofocus></textarea></td>
          </tr>
          <tr>
            <td class="th add-th">Bug修改记录</td>
            <td colspan="4"><textarea id="verBug" placeholder="Bug(错误/问题)修改记录" autofocus></textarea></td>
          </tr>
        </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-white" data-dismiss="modal">关闭</button>
        <button id="saveVerB" type="button" class="btn btn-primary">提交</button>
      </div>
    </div>
  </div>
</div>

</div></body>

<script>alert("101");
var canBrowse=true;//是否允许浏览
var oldVerCfgData=null;//从后台取到的配置数据
var rootPath=getRootPath();
var page={PageSize:"3", Page:"1", AllPage:null, GotoLast:"0"};
var verMap={};

//初始化页面
$(function() {
  /*一、日期处理*/
  $("#data_5 .input-daterange").datepicker({keyboardNavigation:!1,forceParse:!1,autoclose:!0});
  //--设置当前月份
  $("input[name='StartPubTime']").val(getCurMonthFirstDay_format("yyyy-MM-dd"));
  $("input[name='EndPubTime']").val(getCurMonthLastDay_format("yyyy-MM-dd"));

  /*二、工具条按钮控制*/
  $("button[opeType='verconfig']").on("click", function() {
     loadVerCfgAndFill();
  });

  //三、配置窗口处理
  $("#browserB").on("click", function() {//浏览
    if (!canBrowse) return;
    $(".my-mbody").find("input").each(function() {
      $(this).attr("readonly","true");
    });
  });
  $("#updateB").on("click", function() {
    $(".my-mbody").find("input").each(function() {
      $(this).removeAttr("readonly");
    });
  });
  $("#saveCfgB").on("click", function() {
    saveCfg();
  });

  //四、新增修改版本处理
  $("#saveVerB").on("click", function() {
    saveVer();
  });
  $("#verAdd").on("hide.bs.modal", function () {
    cleanVerWin();
  });

  //五、翻页处理，先不进行包装
  $(".pagination .first").on("click", function() {//第一页
    if ($(this).hasClass("disabled")) return;
    page.Page="1";
    listAjax(rootPath+"version/getVerList.do", page, $("#verListArea"), drawVerList);
  });
  $(".pagination .previous").on("click", function() {//上一页
    if ($(this).hasClass("disabled")) return;
    var _p=Number(page.Page);
    if (_p>1) page.Page=(_p-1)+"";
    listAjax(rootPath+"version/getVerList.do", page, $("#verListArea"), drawVerList);
  });
  $(".pagination .next").on("click", function() {//下一页
    if ($(this).hasClass("disabled")) return;
    var _p=Number(page.Page);
    page.Page=(_p+1)+"";
    listAjax(rootPath+"version/getVerList.do", page, $("#verListArea"), drawVerList);
  });
  $(".pagination .last").on("click", function() {//尾页
    if ($(this).hasClass("disabled")) return;
    page.GotoLast="1";
    listAjax(rootPath+"version/getVerList.do", page, $("#verListArea"), drawVerList);
  });
  $(".pagination .jump").on("click", function() {//跳至
    if ($(this).hasClass("disabled")) return;
    var _page=$(".pagination .toPage").val();
    var reg=new RegExp("^[0-9]*$");
    if(!reg.test(_page)) {
      alert("请输入有效页码！");
      return;
    }
    page.Page=_page;
    listAjax(rootPath+"version/getVerList.do", page, $("#verListArea"), drawVerList);
  });

  //六、初始化页面
  $("#verMemo").summernote({
    lang:'zh-CN',
    placeholder:'在此输入版本说明，介绍版本的情况，注意：可不包括bug的修改说明',
    height:150,
    minHeight:150,
    maxHeight:150,
    focus:true
  });
  $("#verBug").summernote({
    lang: 'zh-CN',
    placeholder:'在此输入Bug修改记录，记录和上一个版本相比，都修改了那些Bug',
    height:150,
    minHeight:150,
    maxHeight:150,
    focus: true
  });
  setPage(null);
  listAjax(rootPath+"version/getVerList.do", page, $("#verListArea"), drawVerList);
});

//===================方法
//一、有关版本配置的方法
//装载配置数据，并进行填充显示
function loadVerCfgAndFill() {
  $.ajax({type:"post", async:true, url:rootPath+"version/getVerCfg.do", dataType:"json",
    success: function(jsonData) {
      if (jsonData) {
        if (jsonData.ReturnType!='1001') alert("发生错误：\n\t"+jsonData.ReturnType+"-"+jsonData.Message);
        else {
          var retData=jsonData.VerCfgInfo;
          $("#pubFileName").val(retData.PubFileName?retData.PubFileName:"");
          $("#pubUrl").val(retData.PubUrl?retData.PubUrl:"");
          $("#pubStorePath").val(retData.PubStorePath?retData.PubStorePath:"");
          $("#verGoodsStorePath").val(retData.VerGoodsStorePath?retData.VerGoodsStorePath:"");
          oldVerCfgData=retData;
        }
      }
      canBrowse=true;
      $("#browserB").click();
    },
    error: function(jqXHR){
      alert("发生错误：" + jqXHR.status);
      $("#closeB_verCfg").click();
    }
  });
}
//保存
function saveCfg() {
  //检查数据合法性：目前不进行检查
  //获得新的数据
  if (($.trim($("#pubFileName").val())+$.trim($("#pubFileName").val())+$.trim($("#pubFileName").val())+$.trim($("#pubFileName").val()))=="") {
    alert("没有任何内容，无法保存！");
    return;
  }
  var cfgData={};
  if ($.trim($("#pubFileName").val())!="") cfgData.PubFileName=$.trim($("#pubFileName").val());
  if ($.trim($("#pubUrl").val())!="") cfgData.PubUrl=$.trim($("#pubUrl").val());
  if ($.trim($("#pubStorePath").val())!="") cfgData.PubStorePath=$.trim($("#pubStorePath").val());
  if ($.trim($("#verGoodsStorePath").val())!="") cfgData.VerGoodsStorePath=$.trim($("#verGoodsStorePath").val());

  $.ajax({type:"post", async:true, url:rootPath+"version/saveVerCfg.do", dataType:"json", data: cfgData,
    success: function(jsonData) {
      if (jsonData) {
        if (jsonData.ReturnType!='1001') alert("发生错误：\n\t"+jsonData.ReturnType+"-"+jsonData.Message);
        else {
          canBrowse=true;
          $("#closeB_verCfg").click();
        }
      }
    },
    error: function(jqXHR){
      alert("发生错误：" + jqXHR.status);
    }
  });
}

//二、有关版本的方法
//清空版本界面
function cleanVerWin() {
  $("#verName").val("");
  $("#verNum").val("");
  $("#verFlag").val(1);
  $("#verMemo").summernote("code", "");
  $("#verBug").summernote("code", "");
}
//保存
function saveVer() {
  //检查数据合法性：目前不进行检查
  var checkErr="";
  var focus=0;
  if (!$.trim($("#verName").val())) checkErr+="\n请输入版本名称",(focus==0?focus=1:focus=focus);
  if (!$.trim($("#verNum").val())) checkErr+="\n请输入版本状态",(focus==0?focus=2:focus=focus);
  var memoHtml=$("#verMemo").summernote("code");
  if (!$.trim(getPureStrFromHTML(memoHtml))) checkErr+="\n请输入版本说明",(focus==0?focus=3:focus=focus);
  var bugHtml=$("#verBug").summernote("code");
  if (!$.trim(getPureStrFromHTML(bugHtml))) checkErr+="\n请输入Bug修改记录",(focus==0?focus=4:focus=focus);

  if (checkErr&&focus!=0) {
    alert(checkErr.substring(1));
    alert(focus);
    switch (focus) {
      case 1:
        $("#verName").focus();
        break;
      case 2:
        $("#verNum").focus();
        break;
      case 3:
        $("#verMemo").summernote("focus");
        break;
      case 4:
        $("#verBug").summernote("focus");
        break;
      default: ;
    }
    return;
  }

  var verData={};
  if ($.trim($("#verName").val())!="") verData.AppName=$.trim($("#verName").val());
  if ($.trim($("#verNum").val())!="") verData.Version=$.trim($("#verNum").val());
  if ($.trim($("#verFlag").val())!="") verData.PubFlag=$("#verFlag").val();
  if ($.trim(getPureStrFromHTML(memoHtml))) verData.Descn=$("#verMemo").summernote("code");
  if ($.trim(getPureStrFromHTML(bugHtml))) verData.BugPatch=$("#verBug").summernote("code");

  $.ajax({type:"post", async:true, url:rootPath+"version/insertVer.do", dataType:"json", data: verData,
    success: function(jsonData) {
      if (jsonData) {
        if (jsonData.ReturnType!="1001") alert("发生错误：\n\t"+jsonData.ReturnType+"-"+jsonData.Message);
        else {
          canBrowse=true;
          $("#closeB_ver").click();
        }
      }
    },
    error: function(jqXHR){
      alert("发生错误：" + jqXHR.status);
    }
  });
}

//三、列表操作
/**
 * 处理列表的公共方法
 * @param doUrl 请求列表数据的Url
 * @param param 请求参数，可能包括页信息，过滤查询信息，页面模式信息等
 * @param domObj list所处的html对象，以Jquery形式传入
 * @param callback 回掉函数，注意：此函数包括三个参数，返回的数据值、list所处的html对象、请求参数
 */
function listAjax(doUrl, param, domObj, callback){
  $.ajax({type:"POST", url:doUrl, dataType:"json", data:param,
    beforeSend: function() {
      domObj.find(".cntList").html("<div style='text-align:center;height:300px;line-height:200px;'>数据加载中...</div>");
    },
    success: function(returnData) {
      page.GotoLast="0";
      if (returnData.ReturnType!="1001") domObj.html("<div style='text-align:left;height:300px;padding:20px;padding-top:140px;'>"+returnData.Message+"</div>");
      else {
        domObj.find(".cntList").html(""); //再重新创建新的数据集时，先清空之前的
        callback(returnData, domObj, param); //主要是填充列表区域
      } 
    },
    error: function(jqXHR) {
      domObj.find(".cntList").html("<div style='text-align:center;height:300px;line-height:200px;'>获取数据发生错误："+jqXHR.status+"</div>");
      page.GotoLast="0";
    }     
  });
}

/**
 * 画版本列表。
 * @param listData 版本列表数据
 * @param domObj 列表所在的html的dom对象，jquery形式
 * @param param 其他参数
 */
function drawVerList(listData, domObj, param) {
  if (!domObj) return;
  if (!listData||!listData.ResultList) {
    $(domObj).find(".cntList").html("<div style='text-align:center;height:500px;line-height:300px;'>版本列表无数据！</div>");
    setPage(null);
    return;
  }
  var result=listData.ResultList;
  if (!result||!result.VerList) {
    $(domObj).find(".cntList").html("<div style='text-align:center;height:500px;line-height:300px;'>版本列表无数据！</div>");
    setPage(null);
    return;
  }
  //一、画列表
  var verList=result.VerList;
  var oneVer=null, temp=null;
  var lineDiv=null, checkDiv=null, imgDiv=null, conDiv=null;

  for(var i=0; i<verList.length ;i++) {
    oneVer=verList[i];
    if (!oneVer) continue;

    temp=oneVer.VerId;
    lineDiv=$("<div class='lineBox'></div>");
    lineDiv.attr({verId:(temp?temp:"")});
    //1-选择框
    checkDiv=$("<div class='l-check'><input type='checkBox' name='selVer'/></div>");
    lineDiv.append(checkDiv);
    //2-版本图标
    temp=oneVer.VerImgUrl;
    imgDiv=$("<div class='l-img'><img alt='版本图标' src='"+(temp?temp:"")+"'/></div>");
    lineDiv.append(imgDiv);
    //3-内容区域
    temp=oneVer.AppName;
    temp=(temp?temp:"");
    temp+=(oneVer.Version?("("+oneVer.Version+")"):"");
    conDiv=$("<div class='l-con'><h3>"+temp+"</h3><p class='memo'></p><p class='other'></p></div>");
    temp=oneVer.Descn;
    conDiv.find(".memo").html(temp?temp:"");
    //内容标签：文件大小；发布时间
    temp=oneVer.LastModifyTime;
    conDiv.find(".other").append($("<span>"+(temp?temp:"")+"</span>"));
    temp=oneVer.ApkSize;
    conDiv.find(".other").append($("<span>|</span><span>"+(temp?temp:"")+"</span>"));
    lineDiv.append(conDiv);
    //4-分类信息
    typeDiv=$("<div class='typemark'></div>");
    switch (oneVer.PubFlag) {
      case "0":
        temp="未处理";
        break;
      case "1":
        temp="已发布";
        break;
      case "2":
        temp="已撤销";
        break;
      case "3":
      case "-3":
        temp="已作废";
        break;
      default:
        temp="未知";
    }
    if (oneVer.IsCur=="true") typeDiv.append($("<span style='background-color:#f9be36' title='当前发布版本'>P</span>"));
    else typeDiv.append($("<span style='background-color:#fff;color:#fff;'>P</span>"));
    typeDiv.append($("<span style='background-color:#61b0e8'>"+temp+"</span>"));
    lineDiv.append(typeDiv);

    verMap[oneVer.VerId]=oneVer;
    $(lineDiv).attr("onClick", "drawVerDetail('"+oneVer.VerId+"')");
    //加入列表
    $(domObj).find(".cntList").append(lineDiv);
  }

  //二、设置翻页信息
  page.PageSize=result.PageSize;
  page.Page=result.CurPage;
  if (page.PageSize>0) {
    page.AllPage=parseInt(result.AllCount/page.PageSize);
    page.AllPage=(result.AllCount%page.PageSize>0)?((page.AllPage+1)+""):(page.AllPage+"");
  } else page.AllPage=null;
  setPage(page);
}

/**
 * 画版本的详细区域
 * @param verId 版本id
 */
function drawVerDetail(verId) {
  $("div .detailArea").html("");
  alert(allFields(verMap[verId]));
  alert(verMap[verId].AppName);
  var detailDiv=$("<div></div>");
  detailDiv.html(allFields(verMap[verId]));
  $("div .detailArea").append(detailDiv);
}
</script>
</html>