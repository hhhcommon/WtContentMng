<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta name="keywords" content="Apk, 版本管理">
  <meta name="description" content="实现我听Android平台的Apk文档发布和简单的版本说明功能">

  <title>Apk版本管理</title>
  <link href="../resources/plugins/hplus/css/bootstrap.min.css" rel="stylesheet">
  <link href="../resources/plugins/hplus/css/font-awesome.min.css" rel="stylesheet">

  <link href="../resources/plugins/hplus/css/animate.min.css" rel="stylesheet">
  <link href="../resources/plugins/hplus/css/plugins/datapicker/datepicker3.css" rel="stylesheet">
  <link href="../resources/plugins/hplus/css/style.min.css" rel="stylesheet">
  <link href="../resources/plugins/hplus/css/plugins/jqpagination/jqpagination.css" rel="stylesheet"/>
  
  <link href="../resources/css/publish.css" rel="stylesheet">
  <link href="../resources/wtcm/layout/CM_toolbar.css" rel="stylesheet">
  <link href="../resources/wtcm/layout/CM_mainarea.css" rel="stylesheet">

  <script src="../resources/js/common.utils.js"></script>
  <script src="../resources/plugins/hplus/js/jquery-2.1.1.min.js"></script>

  <script src="../resources/plugins/hplus/js/bootstrap.min.js"></script>
  <script src="../resources/plugins/hplus/js/plugins/jqpagination/jquery.jqpagination.js"></script><!-- 分页 -->
  <script src="../resources/plugins/hplus/js/plugins/datapicker/bootstrap-datepicker.js"></script><!--日期-->
  <script src="../resources/js/context.utils.js"></script>
  <script src="../resources/js/common.utils.js"></script>
  <script src="../resources/wtcm/pagination/CM_title.init.js"></script>
</head>
<style>
<!--
/*模态窗口样式设置*/
.my-mbody {
  background-color: #F8FAFB;
}
.my-mdialog {
  margin:80px auto;
}
h4 {
  font-weight:bold;
  padding-left:10px;
  text-align:left;
}

/* 配置：表单区域 */
.modal-body tr {
  width:100%;
}
.modal-body tr .th {
  margin-left:30px;
  height:60px;
  line-height:36px;
  font-size:14px;
  font-weight:bold;
  font-family:"open sans","Helvetica Neue",Helvetica,Arial,sans-serif;
  width:200px;
  text-width:190px;
  padding-right:10px;
  font-weight:nomal;
  text-align:right;
}
.modal-body tr td input {
  width:380px;
}
.splittr {
  border-top:1px dashed #e5e5e5;
  height:10px;
}
.my-mbody input {
}

/*操作按钮*/
.my-btnOper {
  margin-top:10px;
  margin-left:450px;
}
.my-btnOper button {
  height:28px;
  line-height:28px;
  padding:0px 12px;
}
-->
</style>
<body style="overflow:hidden;"><div style="height:100%">
<!--菜单栏-->
<div class="toobarArea">
  <button type="button" opeType="pass" class="btn" style="margin-right:10px">添加</button>
  <button type="button" opeType="nopass" class="btn" style="margin-right:175px" disabled>删除</button>
  <div class="splite" style="left:300px"></div>
  <button type="button" opeType="verconfig" class="btn" style="margin-right:60px" data-toggle="modal" data-target="#verCfg">配置信息</button>
  <div class="splite" style="left:418px"></div>
  <div class="form-group cDate" id="data_5">
    <span>发布日期：</span>
    <div class="input-daterange input-group" id="datepicker" style="display:inline-block;vertical-align:top;margin-top:2px;">
      <input type="text" class="input-sm form-control" name="StartPubTime" value="" />
      <input type="text" class="input-sm form-control" name="EndPubTime" value="" />
    </div>
  </div>
  <button type="button" class="btn selectBtn" disabled>查 询</button>
</div>

<!--显示主区域-->
<div class="mainArea">
  <!--左侧列表 -->
  <div id="verListArea" class="leftlistArea">
    <!-- 动态节目列表cntList -->
    <div class="cntList">收拾收拾</div>
    <div class="page">
      <div class="gigantic pagination">
        <a href="javascript:void(0);" class="first" data-action="first">&laquo;</a>
        <a href="javascript:void(0);" class="previous" data-action="previous">&lsaquo;</a>
        <input type="text" readonly="readonly" style="width:257px;" value="0"/>
        <a href="javascript:void(0);" class="next" data-action="next">&rsaquo;</a>
        <a href="javascript:void(0);" class="last" data-action="last">&raquo;</a>
      </div>
    </div>
  </div>
  <!--右侧详情-->
  <div class="pubDetail" onselectstart="return false;">
  </div>
</div>

<!--弹出内容：设置配置-->
<div id="verCfg" class="modal inmodal" data-backdrop="static">
  <div class="modal-dialog my-mdialog">
    <div class="modal-content">
      <div class="modal-header" style="padding-bottom:5px;">
        <button type="button" class="close" id="closeB" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title">版本配置信息</h4>
        <div class="btn-group my-btnOper">
          <button id="browserB" class="btn btn-primary" type="button">浏览</button>
          <button id="updateB" class="btn btn-white" type="button">修改</button>
        </div>
      </div>
      <div class="modal-body my-mbody">
        <table>
          <tr>
            <td class="th">当前发布版本Apk名称</td>
            <td><input type="text" class="form-control" id="pubFileName" placeholder="当前发布版本的名称" readonly></td>
          </tr>
          <tr>
            <td class="th">当前发布版本下载地址</td>
            <td><input type="text" class="form-control" id="pubUrl" placeholder="当前发布版本的Url，下载地址就从此获得" readonly></td>
          </tr>
          <tr>
            <td class="th">当前发布版本存储目录</td>
            <td><input type="text" class="form-control" id="pubStorePath" placeholder="服务器端目录设置，默认为/opt/version/cur" readonly></td>
          </tr>
          <tr class="splittr"></tr>
          <tr>
            <td class="th">历史版本发布存储目录</td>
            <td><input type="text" class="form-control" id="verGoodsStorePath" placeholder="服务器端目录设置，默认为/opt/version/his/+{版本序号}" readonly></td>
          </tr>
        </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-white" data-dismiss="modal">关闭</button>
        <button id="saveCfgB" type="button" class="btn btn-primary">保存</button>
      </div>
    </div>
  </div>
</div>

</div></body>

<script>
var canBrowse=true;//是否允许浏览
var oldVerCfgData=null;//从后台取到的配置数据
var rootPath=getRootPath();

//初始化页面
$(function() {
  /*一、日期处理*/
  $("#data_5 .input-daterange").datepicker({keyboardNavigation:!1,forceParse:!1,autoclose:!0});
  //--设置当前月份
  $("input[name='StartPubTime']").val(getCurMonthFirstDay_format("yyyy-MM-dd"));
  $("input[name='EndPubTime']").val(getCurMonthLastDay_format("yyyy-MM-dd"));

  /*二、工具条按钮控制*/
  $("button[opeType='verconfig']").on("click", function() {
     loadVerCfgAndFill();
  });

  //三、配置窗口处理
  $("#browserB").on("click", function() {//浏览
    if (!canBrowse) return;
    $(".my-mbody").find("input").each(function() {
      $(this).attr("readonly","true");
    });
  });
  $("#updateB").on("click", function() {
    $(".my-mbody").find("input").each(function() {
      $(this).removeAttr("readonly");
    });
  });
  $("#saveCfgB").on("click", function() {
    saveCfg();
  });

  //四、初始化页面
  var param={PageSize:"10", Page:"1"};
  listAjax(rootPath+'version/getVerList.do', param, $("#verListArea .cntList"), drawVerList);
});

//===================方法
//一、有关版本配置的方法
//装载配置数据，并进行填充显示
function loadVerCfgAndFill() {
  $.ajax({type:"post", async:true, url:rootPath+'version/getVerCfg.do', dataType:"json",
    success: function(jsonData) {
      if (jsonData) {
        if (jsonData.ReturnType!='1001') alert("发生错误：\n\t"+jsonData.ReturnType+"-"+jsonData.Message);
        else {
          var retData=jsonData.VerCfgInfo;
          $("#pubFileName").val(retData.PubFileName?retData.PubFileName:"");
          $("#pubUrl").val(retData.PubUrl?retData.PubUrl:"");
          $("#pubStorePath").val(retData.PubStorePath?retData.PubStorePath:"");
          $("#verGoodsStorePath").val(retData.VerGoodsStorePath?retData.VerGoodsStorePath:"");
          oldVerCfgData=retData;
        }
      }
      canBrowse=true;
      $("#browserB").click();
    },
    error: function(jqXHR){
      alert("发生错误：" + jqXHR.status);
      $("#closeB").click();
    }
  });
}
//保存
function saveCfg() {
  //检查数据合法性：目前不进行检查
  //获得新的数据
  if (($.trim($("#pubFileName").val())+$.trim($("#pubFileName").val())+$.trim($("#pubFileName").val())+$.trim($("#pubFileName").val()))=="") {
    alert("没有任何内容，无法保存！");
    return;
  }
  var cfgData={};
  if ($.trim($("#pubFileName").val())!="") cfgData.PubFileName=$.trim($("#pubFileName").val());
  if ($.trim($("#pubUrl").val())!="") cfgData.PubUrl=$.trim($("#pubUrl").val());
  if ($.trim($("#pubStorePath").val())!="") cfgData.PubStorePath=$.trim($("#pubStorePath").val());
  if ($.trim($("#verGoodsStorePath").val())!="") cfgData.VerGoodsStorePath=$.trim($("#verGoodsStorePath").val());

  $.ajax({type:"post", async:true, url:rootPath+'version/saveVerCfg.do', dataType:"json", data: cfgData,
    success: function(jsonData) {
      if (jsonData) {
        if (jsonData.ReturnType!='1001') alert("发生错误：\n\t"+jsonData.ReturnType+"-"+jsonData.Message);
        else {
          canBrowse=true;
          $("#closeB").click();
        }
      }
    },
    error: function(jqXHR){
      alert("发生错误：" + jqXHR.status);
    }
  });
}

//二、有关版本的方法
function dealFun(data) {
  successData=data;
}

//三、列表操作
/**
 * 处理列表的公共方法
 * @param doUrl 请求列表数据的Url
 * @param param 请求参数，可能包括页信息，过滤查询信息，页面模式信息等
 * @param domObj list所处的html对象，以Jquery形式传入
 * @param callback 回掉函数，注意：此函数包括三个参数，返回的数据值、list所处的html对象、请求参数
 */
function listAjax(doUrl, param, domObj, callback){
  $.ajax({type:"POST", url:doUrl, dataType:"json", data:param,
    beforeSend: function() {
      domObj.html("<div style='text-align:center;height:300px;line-height:200px;'>数据加载中...</div>");
    },
    success: function(returnData) {
      if (returnData.ReturnType!="1001") domObj.html("<div style='text-align:left;height:300px;padding:20px;padding-top:140px;'>"+returnData.Message+"</div>");
      else {
        domObj.html(""); //再重新创建新的数据集时，先清空之前的
        callback(returnData, domObj, param); //主要是填充列表区域
      } 
    },
    error: function(jqXHR) {
      domObj.html("<div style='text-align:center;height:300px;line-height:200px;'>获取数据发生错误："+jqXHR.status+"</div>");
    }     
  });
}

/**
 * 画版本列表。
 * @param listData 版本列表数据
 * @param domObj 列表所在的html的dom对象，jquery形式
 * @param param 其他参数
 */
function drawVerList(listData, domObj, param) {
  if (!domObj) return;
  if (!listData||!listData.ResultList) {
    $(domObj).html("<div style='text-align:center;height:500px;line-height:300px;'>版本列表无数据！</div>");
    return;
  }
  var result=listData.ResultList;
  if (!result||!result.VerList) {
    $(domObj).html("<div style='text-align:center;height:500px;line-height:300px;'>版本列表无数据！</div>");
    return;
  }
  var verList=result.VerList;
  //设置翻页信息
  //画列表
  var oneVer=null, temp=null;
  var listDiv=null, checkDiv=null, imgDiv=null, conDiv=null;
  for(var i=0; i<verList.length ;i++) {
    oneVer=verList[i];
    if (!oneVer) continue;

    temp=oneVer.VerId;
    listDiv=$("<div class='listBox'></div>");
    listDiv.attr({verId:(temp?temp:"")});
    //1-选择框
    checkDiv=$("<div class='listCheck'><input type='checkBox' name='selVer'/></div>");
    listDiv.append(checkDiv);
    //2-版本图标
    temp=oneVer.VerImgUrl;
    imgDiv=$("<div class='listImg'><img alt='版本图标' src='"+(temp?temp:"")+"'/></div>");
    listDiv.append(imgDiv);
    //3-内容区域
    temp=oneVer.AppName;
    temp=(temp?temp:"");
    temp+=(oneVer.Version?("("+oneVer.Version+")"):"");
    conDiv=$("<div class='listCon'><h3>"+temp+"</h3><p class='secTitle'></p><p class='other'></p></div>");
    temp=oneVer.Descn;
    conDiv.find(".secTitle").html(temp?temp:"");
    //内容标签：文件大小；发布时间
    temp=oneVer.LastModifyTime;
    conDiv.find(".other").append($("<span>"+(temp?temp:"")+"</span>"));
    temp=oneVer.ApkSize;
    conDiv.find(".other").append($("<span>|</span><span>"+(temp?temp:"")+"</span>"));
    listDiv.append(conDiv);
    //4-分类信息
    typeDiv=$("<div class='sortUpdate'></div>");
    switch (oneVer.PubFlag) {
      case "0":
        temp="未处理";
        break;
      case "1":
        temp="已发布";
        break;
      case "2":
        temp="已撤销";
        break;
      case "3":
      case "-3":
        temp="已作废";
        break;
      default:
        temp="未知";
    }
    if (oneVer.IsCur) typeDiv.append($("<span style='background-color:#f9be36' title='当前发布版本'>P</span>"));
    typeDiv.append($("<span style='background-color:#61b0e8'>"+temp+"</span>"));
    listDiv.append(typeDiv);
    //加入列表
    $(domObj).append(listDiv);
  }
}
</script>
</html>